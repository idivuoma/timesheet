<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Timesheet App</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  <div id="error-container" style="color:red;font-size:16px;margin:12px;display:none;"></div>

  <script type="text/babel">

    const KM_RATE = 3.5;
    const TRAILER_EXTRA_RATE = 1.5;
    const FOOD_FULL = 678;
    const FOOD_HALF = 339;
    const currencies = ["NOK", "EUR", "USD"];
    const projects = ["Project A", "Project B", "Project C"];
    const countries = ["Norway", "Sweden", "Finland", "Denmark"];

    function App() {
      const [employeeInfo, setEmployeeInfo] = React.useState({
        firstName: "", lastName: "", address: "", country: "",
        iban: "", ssn: "", email: "", project: "",
        startDate: "", endDate: ""
      });
      const [isEmployeeInfoComplete, setIsEmployeeInfoComplete] = React.useState(false);
      const [activePage, setActivePage] = React.useState("timesheet");
      const [timesheet, setTimesheet] = React.useState({});
      const [trips, setTrips] = React.useState([]);
      const [expenses, setExpenses] = React.useState([]);
      const [travelSkipped, setTravelSkipped] = React.useState(false);
      const [expensesSkipped, setExpensesSkipped] = React.useState(false);
      const [signature, setSignature] = React.useState("");

      // ================= Utils =================
      const generateDateRange = (start, end)=>{
        if (!start || !end) return [];
        let startDate = new Date(start), endDate = new Date(end);
        let dates=[], current = new Date(startDate);
        while(current <= endDate){
          const d = current.toISOString().split("T")[0];
          const dayName = current.toLocaleDateString("en-US",{weekday:"short"});
          dates.push({date:d,dayName,displayDate:current.toLocaleDateString()});
          current.setDate(current.getDate()+1);
        }
        return dates;
      };
      const calculateDayHours = (start,end,lunch)=>{
        if(!start||!end) return 0;
        let sMin = parseFloat(start.split(":")[0])*60+parseFloat(start.split(":")[1]);
        let eMin = parseFloat(end.split(":")[0])*60+parseFloat(end.split(":")[1]);
        let diff = (eMin-sMin-(parseFloat(lunch)||0))/60;
        return diff>0?diff:0;
      };
      const calculateDayStatus=(h)=>{
        if(h===0) return {type:"none"};
        if(h<5) return {type:"partial",hours:h};
        if(h>=5 && h<=7.5) return {type:"full"};
        if(h>7.5) return {type:"overtime", overtime:h-7.5};
      }
      const getFoodReimbursementAmount=(val)=> val==="full"?FOOD_FULL:val==="half"?FOOD_HALF:0;

      const getTimesheetTotals=()=>{
        let totalHours=0, totalOT=0, totalFood=0, days=0;
        for(const [date,e] of Object.entries(timesheet)){
          const h = calculateDayHours(e.start,e.end,e.lunch);
          const st = calculateDayStatus(h);
          if(st.type==="partial"){totalHours+=st.hours;}
          if(st.type==="full"){totalHours+=7.5; days++;}
          if(st.type==="overtime"){totalHours+=7.5; totalOT+=st.overtime; days++;}
          totalFood += getFoodReimbursementAmount(e.foodReimbursement);
        }
        return {totalHours,totalOvertime:totalOT,totalFoodReimbursement:totalFood,workDays:days};
      }
      const updateTimesheet=(d,f,v)=>setTimesheet({...timesheet, [d]:{...timesheet[d],[f]:v}});

      const calcTripReimbursement=(t)=>{
        const km=parseFloat(t.km)||0;
        let rate=KM_RATE+(t.trailer?TRAILER_EXTRA_RATE:0);
        return km*rate;
      };
      const getTravelTotals=()=>{
        let totalKm=0,totalReimb=0;
        trips.forEach(t=>{totalKm+=(parseFloat(t.km)||0); totalReimb+=calcTripReimbursement(t)});
        return {totalKm,totalReimb};
      };

      const convertToNOK=(amt,curr)=>{
        let r={NOK:1,EUR:11,USD:10};
        return (parseFloat(amt)||0)*(r[curr]||1);
      };
      const getExpensesTotals=()=>{
        return {totalNOK: expenses.reduce((a,e)=>a+convertToNOK(e.amount,e.currency),0)};
      };

      // ================= Print As PDF =================
      const printAsPDF=()=>{
        const timesheetTotals = getTimesheetTotals();
        const travelTotals = getTravelTotals();
        const expensesTotals = getExpensesTotals();
        const style = "<style>body{font-family:Arial;}h1{color:#333;} .section{margin-bottom:20px;}</style>";
        const html = `
          <html>
            <head><meta charset="utf-8"/>${style}<title>Submission</title></head>
            <body>
              <h1>Submission - ${employeeInfo.firstName} ${employeeInfo.lastName}</h1>
              <div class="section"><h2>Timesheet</h2>
                Paid: ${timesheetTotals.totalHours}h<br/>
                Overtime: ${timesheetTotals.totalOvertime}h<br/>
                Food: ${timesheetTotals.totalFoodReimbursement} NOK
              </div>
              <div class="section"><h2>Travel</h2>
                ${travelSkipped?"Skipped": travelTotals.totalKm+" km | "+travelTotals.totalReimb+" NOK"}
              </div>
              <div class="section"><h2>Expenses</h2>
                ${expensesSkipped?"Skipped": expensesTotals.totalNOK+" NOK"}
              </div>
              <div class="section"><h2>Signature</h2>
                <div>` + (signature ? "Signed by " + signature : "Not signed") + `</div>
              </div>
              <script>window.onload=()=>window.print();<\/script>
            </body>
          </html>
        `;
        const w=window.open("","_blank");
        w.document.open(); w.document.write(html); w.document.close();
      };

      // ================= Render =================
      if(!isEmployeeInfoComplete){
        return (
          <div className="p-6 max-w-2xl mx-auto">
            <h1 className="text-2xl font-bold mb-4">Employee Information</h1>
            {["firstName","lastName","address","iban","ssn","email"].map(f=>(
              <input key={f} placeholder={f} className="border p-2 w-full mb-2 rounded"
                value={employeeInfo[f]}
                onChange={(e)=>setEmployeeInfo({...employeeInfo,[f]:e.target.value})}/>
            ))}
            <select className="border p-2 mb-2 w-full rounded" value={employeeInfo.country}
              onChange={(e)=>setEmployeeInfo({...employeeInfo,country:e.target.value})}>
              <option value="">Select Country</option>
              {countries.map(c=><option key={c}>{c}</option>)}
            </select>
            <select className="border p-2 mb-2 w-full rounded" value={employeeInfo.project}
              onChange={(e)=>setEmployeeInfo({...employeeInfo,project:e.target.value})}>
              <option value="">Select Project</option>
              {projects.map(p=><option key={p}>{p}</option>)}
            </select>
            <label>Start Date</label>
            <input type="date" className="border p-2 mb-2 w-full rounded"
              value={employeeInfo.startDate}
              onChange={(e)=>setEmployeeInfo({...employeeInfo,startDate:e.target.value})}/>
            <label>End Date</label>
            <input type="date" className="border p-2 mb-2 w-full rounded"
              value={employeeInfo.endDate}
              onChange={(e)=>setEmployeeInfo({...employeeInfo,endDate:e.target.value})}/>
            <button onClick={()=>setIsEmployeeInfoComplete(true)}
              className="px-4 py-2 bg-blue-600 text-white rounded">Continue</button>
          </div>
        );
      }

      const timesheetTotals=getTimesheetTotals();
      const travelTotals=getTravelTotals();
      const expensesTotals=getExpensesTotals();
      const dates=generateDateRange(employeeInfo.startDate, employeeInfo.endDate);

      return (
        <div className="p-6 max-w-3xl mx-auto">
          <h1 className="text-2xl font-bold mb-4">Employee Submission</h1>
          <div className="mb-4">
            <strong>{employeeInfo.firstName} {employeeInfo.lastName}</strong> | {employeeInfo.project}
          </div>

          {/* Nav tabs */}
          <div className="flex space-x-2 mb-4">
            {["timesheet","travel","expenses","signature"].map(pg=>(
              <button key={pg} onClick={()=>setActivePage(pg)}
                className={"px-3 py-1 border rounded "+(activePage===pg?"bg-blue-500 text-white":"bg-white")}>
                {pg}
              </button>
            ))}
          </div>

          {activePage==="timesheet" && (
            <div>
              <h2 className="font-bold mb-2">Timesheet</h2>
              {dates.map(({date,dayName,displayDate})=>{
                const entry=timesheet[date]||{start:"",end:"",lunch:"",foodReimbursement:"none"};
                const h=calculateDayHours(entry.start,entry.end,entry.lunch);
                const s=calculateDayStatus(h);
                const f=getFoodReimbursementAmount(entry.foodReimbursement);
                return (
                  <div key={date} className="border p-2 mb-2 rounded">
                    <div>{dayName} - {displayDate}</div>
                    <input type="time" value={entry.start} onChange={(e)=>updateTimesheet(date,"start",e.target.value)}/> 
                    → <input type="time" value={entry.end} onChange={(e)=>updateTimesheet(date,"end",e.target.value)}/>
                    Lunch: <input type="number" className="border w-16" value={entry.lunch}
                      onChange={(e)=>updateTimesheet(date,"lunch",e.target.value)}/>
                    <select value={entry.foodReimbursement}
                      onChange={(e)=>updateTimesheet(date,"foodReimbursement",e.target.value)}>
                      <option value="none">None</option>
                      <option value="half">Half (339 NOK)</option>
                      <option value="full">Full (678 NOK)</option>
                    </select>
                    <div>
                      {h.toFixed(2)}h → {s.type==="full"?"7.5h paid":s.type==="overtime"?"7.5h+"+s.overtime+"h OT":s.type}
                      {f>0 && ` +${f} NOK`}
                    </div>
                  </div>
                );
              })}
              <div className="mt-4">Total Paid: {timesheetTotals.totalHours}h | OT: {timesheetTotals.totalOvertime}h | Food: {timesheetTotals.totalFoodReimbursement} NOK</div>
            </div>
          )}

          {activePage==="travel" && (
            <div>
              <h2 className="font-bold mb-2">Travel</h2>
              <button onClick={()=>setTravelSkipped(!travelSkipped)} className="px-3 py-1 bg-gray-300 rounded mb-2">Skip Travel</button>
              {!travelSkipped && (
                <div>
                  {trips.map((t,i)=>(
                    <div key={i} className="border p-2 mb-2">
                      <input type="date" value={t.date} onChange={(e)=>{const nt=[...trips]; nt[i].date=e.target.value; setTrips(nt);}} className="border"/>
                      <input placeholder="From" className="border ml-2" value={t.from} onChange={(e)=>{const nt=[...trips];nt[i].from=e.target.value;setTrips(nt);}}/>
                      <input placeholder="To" className="border ml-2" value={t.to} onChange={(e)=>{const nt=[...trips];nt[i].to=e.target.value;setTrips(nt);}}/>
                      <input type="number" placeholder="KM" className="border ml-2 w-20" value={t.km} onChange={(e)=>{const nt=[...trips];nt[i].km=e.target.value;setTrips(nt);}}/>
                      <label><input type="checkbox" checked={t.trailer} onChange={(e)=>{const nt=[...trips];nt[i].trailer=e.target.checked;setTrips(nt);}}/>Trailer</label>
                      ({calcTripReimbursement(t)} NOK)
                    </div>
                  ))}
                  <button onClick={()=>setTrips([...trips,{date:"",from:"",to:"",km:"",trailer:false}])}
                    className="px-3 py-1 bg-green-500 text-white rounded">+ Add Trip</button>
                  <div className="mt-2">Totals: {travelTotals.totalKm} km | {travelTotals.totalReimb} NOK</div>
                </div>
              )}
            </div>
          )}

          {activePage==="expenses" && (
            <div>
              <h2 className="font-bold mb-2">Expenses</h2>
              <button onClick={()=>setExpensesSkipped(!expensesSkipped)} className="px-3 py-1 bg-gray-300 rounded mb-2">Skip Expenses</button>
              {!expensesSkipped && (
                <div>
                  {expenses.map((e,i)=>(
                    <div key={i} className="border p-2 mb-2">
                      <input type="date" value={e.date} onChange={(ev)=>{const ne=[...expenses];ne[i].date=ev.target.value;setExpenses(ne);}}/>
                      <input placeholder="Description" className="border ml-2" value={e.description} onChange={(ev)=>{const ne=[...expenses];ne[i].description=ev.target.value;setExpenses(ne);}}/>
                      <input type="number" placeholder="Amount" className="border ml-2" value={e.amount} onChange={(ev)=>{const ne=[...expenses];ne[i].amount=ev.target.value;setExpenses(ne);}}/>
                      <select value={e.currency} onChange={(ev)=>{const ne=[...expenses]; ne[i].currency=ev.target.value; setExpenses(ne);}}>
                        {currencies.map(c=><option key={c}>{c}</option>)}
                      </select>
                      = {convertToNOK(e.amount,e.currency)} NOK
                    </div>
                  ))}
                  <button onClick={()=>setExpenses([...expenses,{date:"",description:"",amount:"",currency:"NOK"}])}
                    className="px-3 py-1 bg-green-500 text-white rounded">+ Add Expense</button>
                  <div className="mt-2">Total Expenses: {expensesTotals.totalNOK} NOK</div>
                </div>
              )}
            </div>
          )}

          {activePage==="signature" && (
            <div>
              <h2 className="font-bold mb-2">Summary & Signature</h2>
              <div>Timesheet {timesheetTotals.totalHours}h paid, {timesheetTotals.totalOvertime}h OT, {timesheetTotals.totalFoodReimbursement} NOK</div>
              <div>Travel {travelSkipped?"Skipped":travelTotals.totalKm+"km, "+travelTotals.totalReimb+" NOK"}</div>
              <div>Expenses {expensesSkipped?"Skipped":expensesTotals.totalNOK+" NOK"}</div>
              <input placeholder="Digital Signature" className="border p-2 w-full mt-2"
                value={signature} onChange={(e)=>setSignature(e.target.value)}/>
              {signature && <div className="mt-2">✓ Signed by: {signature}</div>}
              <button disabled={!signature} onClick={printAsPDF}
                className={"px-4 py-2 mt-3 rounded "+(signature?"bg-green-600 text-white":"bg-gray-300")}>Download PDF</button>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));

  </script>
</body>
</html>
