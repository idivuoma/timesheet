<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Employee Submission System</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    html, body { background: #0f172a; }
    .card { background: #0b1220; border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    .field { background: #0b1220; border: 1px solid rgba(255,255,255,0.07); color: #e5e7eb; }
    .field:focus { outline: none; box-shadow: 0 0 0 3px #2563eb40; border-color: #2563eb; }
    .btn { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: 1px solid rgba(255,255,255,0.1); }
    .btn:hover { filter: brightness(1.05); }
    .muted { color: #9ca3af; }
    .dragging { border-color: #60a5fa !important; background-color: #1e293b !important; }
    .tab-active { background: #0b1220; border-bottom: 2px solid #60a5fa; color: #e5e7eb; }
    .tab { color: #9ca3af; }
  </style>
</head>
<body class="text-gray-100">
  <div id="app" class="max-w-6xl mx-auto p-4 sm:p-6"></div>

  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    const NOK_FOOD_REIMBURSE = 678;
    const KM_RATE = 3.5; // NOK per km

    const initialInfo = {
      firstName: '', lastName: '', employeeId: '', department: '',
      address: '', country: '', bankaccount: '', ssn: '', email: '',
      project: '', weekStart: '', weekEnd: ''
    };

    const emptyDay = (dateStr='') => ({ 
      date: dateStr, start: '', end: '', lunchMins: 0, note: '', foodSelfPaid: false 
    });

    function hoursBetween(start, end) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(':').map(Number);
      const [eh, em] = end.split(':').map(Number);
      let s = sh*60+sm, e = eh*60+em;
      if (e < s) e += 24*60; // cross midnight
      return (e - s)/60;
    }

    function dateRange(startStr, endStr) {
      if (!startStr || !endStr) return [];
      const out = [];
      const start = new Date(startStr);
      const end = new Date(endStr);
      if (isNaN(start) || isNaN(end) || start > end) return out;
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        out.push(d.toISOString().slice(0,10));
      }
      return out;
    }

    function useLocalStorage(key, initial) {
      const [state, setState] = useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initial;
        } catch { return initial; }
      });
      useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
      }, [key, state]);
      return [state, setState];
    }

    function TopBar({ step, setStep }) {
      const tabs = [
        { id:0, label:'Employee Info' },
        { id:1, label:'Timesheet' },
        { id:2, label:'Travel' },
        { id:3, label:'Expenses' },
        { id:4, label:'Review & Sign' },
      ];
      return (
        <div className="sticky top-0 z-10 mb-4">
          <div className="card rounded-xl p-2 flex gap-2 overflow-x-auto">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setStep(t.id)}
                className={(step===t.id? 'tab-active':'tab') + ' px-4 py-2 rounded-lg whitespace-nowrap'}>
                {t.label}
              </button>
            ))}
          </div>
        </div>
      );
    }

    function InfoPage({ info, setInfo, onNext }) {
      const projects = ['Project A','Project B','Project C'];
      function update(k, v){ setInfo({ ...info, [k]: v }); }
      const ready = Object.values({ ...info, }).every(v => String(v).trim() !== '');

      return (
        <div className="card rounded-2xl p-6">
          <h2 className="text-2xl font-semibold mb-4">Employee Information</h2>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm muted mb-1">First name</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.firstName} 
                onChange={e=>update('firstName', e.target.value)} placeholder="e.g., Ola" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Last name</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.lastName} 
                onChange={e=>update('lastName', e.target.value)} placeholder="e.g., Nordmann" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Employee ID</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.employeeId} 
                onChange={e=>update('employeeId', e.target.value)} placeholder="Your internal ID" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Department</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.department} 
                onChange={e=>update('department', e.target.value)} placeholder="Team / Dept" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-sm muted mb-1">Full address</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.address} 
                onChange={e=>update('address', e.target.value)} placeholder="Street, City, Postal code" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Country</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.country} 
                onChange={e=>update('country', e.target.value)} placeholder="e.g., Norway" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Bankaccount</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.bankaccount} 
                onChange={e=>update('bankaccount', e.target.value)} placeholder="e.g., IBAN / account no." />
              <p className="text-xs muted mt-1">Provide your payout account (IBAN or local format).</p>
            </div>
            <div>
              <label className="block text-sm muted mb-1">Social security number</label>
              <input className="w-full field rounded-lg px-3 py-2" value={info.ssn} 
                onChange={e=>update('ssn', e.target.value)} placeholder="Confidential - used for payroll only" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Email</label>
              <input type="email" className="w-full field rounded-lg px-3 py-2" value={info.email} 
                onChange={e=>update('email', e.target.value)} placeholder="your@email.com" />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Project</label>
              <select className="w-full field rounded-lg px-3 py-2" value={info.project} 
                onChange={e=>update('project', e.target.value)}>
                <option value="">Select project</option>
                {projects.map(p => <option key={p} value={p}>{p}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm muted mb-1">Week start</label>
              <input type="date" className="w-full field rounded-lg px-3 py-2" value={info.weekStart} 
                onChange={e=>update('weekStart', e.target.value)} />
            </div>
            <div>
              <label className="block text-sm muted mb-1">Week end</label>
              <input type="date" className="w-full field rounded-lg px-3 py-2" value={info.weekEnd} 
                onChange={e=>update('weekEnd', e.target.value)} />
            </div>
          </div>
          <div className="flex items-start gap-4 mt-6">
            <button className="btn px-5 py-2 rounded-lg" disabled={!ready} onClick={onNext}>
              Next: Timesheet <i className="fa-solid fa-arrow-right ml-2"></i>
            </button>
            {!ready && <p className="muted text-sm">Please complete all fields to proceed.</p>}
          </div>
        </div>
      );
    }

    function TimesheetPage({ info, timesheet, setTimesheet, onPrev, onNext }) {
      const days = useMemo(() => dateRange(info.weekStart, info.weekEnd), [info.weekStart, info.weekEnd]);

      useEffect(() => {
        const map = new Map(timesheet.map(d => [d.date, d]));
        const updated = days.map(d => map.get(d) || emptyDay(d));
        setTimesheet(updated);
      }, [info.weekStart, info.weekEnd]);

      function updateRow(idx, key, val){
        const copy = [...timesheet];
        copy[idx] = { ...copy[idx], [key]: val };
        setTimesheet(copy);
      }

      const totals = useMemo(() => {
        let totalHours = 0, overtime = 0, foodTotal = 0;
        timesheet.forEach(d => {
          const h = hoursBetween(d.start, d.end) - (Number(d.lunchMins)||0)/60;
          const dayHours = Math.max(0, h);
          totalHours += dayHours;
          if (dayHours > 8) overtime += (dayHours - 8);
          if (d.foodSelfPaid) foodTotal += NOK_FOOD_REIMBURSE;
        });
        return { 
          totalHours: Number(totalHours.toFixed(2)), 
          overtime: Number(overtime.toFixed(2)), 
          foodTotal 
        };
      }, [timesheet]);

      return (
        <div className="card rounded-2xl p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-2xl font-semibold">Timesheet</h2>
            <div className="text-sm muted">Date range: {info.weekStart || '—'} to {info.weekEnd || '—'}</div>
          </div>

          <div className="rounded-xl overflow-hidden border border-gray-700">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-800 text-gray-300">
                <tr>
                  <th className="p-2 text-left">Date</th>
                  <th className="p-2">Start</th>
                  <th className="p-2">End</th>
                  <th className="p-2">Lunch (mins)</th>
                  <th className="p-2 text-left">Notes</th>
                  <th className="p-2">Food self-paid?</th>
                  <th className="p-2">Hours</th>
                </tr>
              </thead>
              <tbody>
                {timesheet.map((d, idx) => {
                  const h = Math.max(0, hoursBetween(d.start, d.end) - (Number(d.lunchMins)||0)/60);
                  return (
                    <tr key={d.date || idx} className="odd:bg-gray-900 even:bg-gray-900/60">
                      <td className="p-2">{d.date || '—'}</td>
                      <td className="p-2">
                        <input type="time" className="field rounded px-2 py-1 w-28" 
                          value={d.start} onChange={e=>updateRow(idx,'start', e.target.value)} />
                      </td>
                      <td className="p-2">
                        <input type="time" className="field rounded px-2 py-1 w-28" 
                          value={d.end} onChange={e=>updateRow(idx,'end', e.target.value)} />
                      </td>
                      <td className="p-2">
                        <input type="number" min="0" className="field rounded px-2 py-1 w-24" 
                          value={d.lunchMins} onChange={e=>updateRow(idx,'lunchMins', e.target.value)} />
                      </td>
                      <td className="p-2 w-80">
                        <input className="field rounded px-2 py-1 w-full" 
                          placeholder="Optional note for this day" value={d.note} 
                          onChange={e=>updateRow(idx,'note', e.target.value)} />
                      </td>
                      <td className="p-2 text-center">
                        <input type="checkbox" checked={d.foodSelfPaid} 
                          onChange={e=>updateRow(idx,'foodSelfPaid', e.target.checked)} />
                      </td>
                      <td className="p-2 text-center">{h.toFixed(2)}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="mt-4 p-3 rounded-lg bg-blue-900/30 border border-blue-700 text-blue-100">
            <strong>Food reimbursement help:</strong> Tick "Food self-paid" only when you had to buy your own food while working off-site or under company policy. The reimbursement rate is {NOK_FOOD_REIMBURSE} NOK per day.
          </div>

          <div className="mt-4 grid sm:grid-cols-3 gap-4">
            <div className="p-3 rounded-lg bg-gray-900 border border-gray-700">
              <div className="muted text-xs">Total hours</div>
              <div className="text-xl font-semibold">{totals.totalHours}</div>
            </div>
            <div className="p-3 rounded-lg bg-gray-900 border border-gray-700">
              <div className="muted text-xs">Overtime</div>
              <div className="text-xl font-semibold">{totals.overtime}</div>
            </div>
            <div className="p-3 rounded-lg bg-gray-900 border border-gray-700">
              <div className="muted text-xs">Food reimbursement</div>
              <div className="text-xl font-semibold">{totals.foodTotal} NOK</div>
            </div>
          </div>

          <div className="flex flex-wrap gap-3 mt-6">
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={onPrev}>
              <i className="fa-solid fa-arrow-left mr-2"></i>Previous
            </button>
            <button className="btn px-4 py-2 rounded-lg" onClick={onNext}>
              Next: Travel<i className="fa-solid fa-arrow-right ml-2"></i>
            </button>
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={onNext}>
              Skip Travel
            </button>
          </div>
        </div>
      );
    }

    function TravelPage({ trips, setTrips, onPrev, onNext }) {
      function addTrip(){ 
        setTrips([...trips, { date:'', from:'', to:'', km:'', note:'' }]); 
      }
      function update(i,k,v){ 
        const c=[...trips]; 
        c[i]={...c[i],[k]:v}; 
        setTrips(c); 
      }
      function remove(i){ 
        const c=[...trips]; 
        c.splice(i,1); 
        setTrips(c); 
      }

      const totalKm = trips.reduce((s,t)=> s + (parseFloat(t.km)||0), 0);
      const totalReimb = Number((totalKm * KM_RATE).toFixed(2));

      return (
        <div className="card rounded-2xl p-6">
          <h2 className="text-2xl font-semibold mb-4">Travel Expenses</h2>
          <div className="space-y-4">
            {trips.map((t,i)=> (
              <div key={i} className="p-4 rounded-xl bg-gray-900 border border-gray-700 grid md:grid-cols-6 gap-3">
                <input type="date" className="field rounded px-3 py-2" value={t.date} 
                  onChange={e=>update(i,'date',e.target.value)} />
                <input className="field rounded px-3 py-2" placeholder="From" value={t.from} 
                  onChange={e=>update(i,'from',e.target.value)} />
                <input className="field rounded px-3 py-2" placeholder="To" value={t.to} 
                  onChange={e=>update(i,'to',e.target.value)} />
                <input type="number" className="field rounded px-3 py-2" placeholder="Kilometers" 
                  value={t.km} onChange={e=>update(i,'km',e.target.value)} />
                <input className="field rounded px-3 py-2 md:col-span-2" placeholder="Note (optional)" 
                  value={t.note} onChange={e=>update(i,'note',e.target.value)} />
                <div className="md:col-span-6 flex justify-between items-center">
                  <div className="muted text-sm">{t.km || 0} km × {KM_RATE} NOK/km</div>
                  <button className="px-3 py-1 rounded-lg border border-gray-600" onClick={()=>remove(i)}>
                    <i className="fa-solid fa-trash"></i>
                  </button>
                </div>
              </div>
            ))}
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={addTrip}>
              <i className="fa-solid fa-plus mr-2"></i>Add trip
            </button>
          </div>

          <div className="mt-4 grid sm:grid-cols-2 gap-4">
            <div className="p-3 rounded-lg bg-gray-900 border border-gray-700">
              <div className="muted text-xs">Total km</div>
              <div className="text-xl font-semibold">{totalKm}</div>
            </div>
            <div className="p-3 rounded-lg bg-gray-900 border border-gray-700">
              <div className="muted text-xs">Reimbursement</div>
              <div className="text-xl font-semibold">{totalReimb} NOK</div>
            </div>
          </div>

          <div className="flex flex-wrap gap-3 mt-6">
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={onPrev}>
              <i className="fa-solid fa-arrow-left mr-2"></i>Previous
            </button>
            <button className="btn px-4 py-2 rounded-lg" onClick={onNext}>
              Next: Expenses<i className="fa-solid fa-arrow-right ml-2"></i>
            </button>
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={onNext}>
              Skip Expenses
            </button>
          </div>
        </div>
      );
    }

    function useDragAndDrop(onFiles) {
      const ref = useRef(null);
      useEffect(()=>{
        const el = ref.current; 
        if (!el) return;

        function stop(e){ e.preventDefault(); e.stopPropagation(); }
        function onDragEnter(e){ stop(e); el.classList.add('dragging'); }
        function onDragOver(e){ stop(e); }
        function onDragLeave(e){ stop(e); el.classList.remove('dragging'); }
        function onDrop(e){ 
          stop(e); 
          el.classList.remove('dragging'); 
          const files = Array.from(e.dataTransfer.files||[]); 
          onFiles(files); 
        }

        el.addEventListener('dragenter', onDragEnter);
        el.addEventListener('dragover', onDragOver);
        el.addEventListener('dragleave', onDragLeave);
        el.addEventListener('drop', onDrop);

        return ()=>{
          el.removeEventListener('dragenter', onDragEnter);
          el.removeEventListener('dragover', onDragOver);
          el.removeEventListener('dragleave', onDragLeave);
          el.removeEventListener('drop', onDrop);
        };
      }, [onFiles]);
      return ref;
    }

    async function filesToImages(files) {
      const results = [];
      for (const f of files) {
        if (!f.type.startsWith('image/')) continue;
        const dataUrl = await new Promise(res=>{
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(f);
        });
        results.push({ 
          id: Math.random().toString(36).slice(2), 
          name: f.name, 
          dataUrl, 
          rotation: 0 
        });
      }
      return results;
    }

    function ExpensesPage({ expenses, setExpenses, onPrev, onNext }) {
      const inputRef = useRef(null);
      const dndRef = useDragAndDrop(async (files)=>{
        const imgs = await filesToImages(files);
        setExpenses({ ...expenses, receipts: [...expenses.receipts, ...imgs] });
      });

      function addItem(){ 
        setExpenses({ 
          ...expenses, 
          items: [...expenses.items, { date:'', type:'taxi', amount:'', note:'' }]
        }); 
      }

      function updateItem(i,k,v){ 
        const items=[...expenses.items]; 
        items[i] = { ...items[i], [k]: v }; 
        setExpenses({ ...expenses, items }); 
      }

      function removeItem(i){ 
        const items=[...expenses.items]; 
        items.splice(i,1); 
        setExpenses({ ...expenses, items }); 
      }

      async function onPickFiles(e){ 
        const imgs = await filesToImages(Array.from(e.target.files||[])); 
        setExpenses({ ...expenses, receipts: [...expenses.receipts, ...imgs] }); 
        e.target.value=''; 
      }

      function rotate(id, delta){ 
        setExpenses({ 
          ...expenses, 
          receipts: expenses.receipts.map(r=> 
            r.id===id ? { ...r, rotation: (r.rotation+delta+360)%360 } : r 
          )
        }); 
      }

      function removeImg(id){ 
        setExpenses({ 
          ...expenses, 
          receipts: expenses.receipts.filter(r=> r.id!==id) 
        }); 
      }

      const total = expenses.items.reduce((s,it)=> s + (parseFloat(it.amount)||0), 0);

      return (
        <div className="card rounded-2xl p-6">
          <h2 className="text-2xl font-semibold mb-4">Expenses</h2>
          <div className="space-y-4">
            {expenses.items.map((it,i)=> (
              <div key={i} className="p-4 rounded-xl bg-gray-900 border border-gray-700 grid md:grid-cols-6 gap-3">
                <input type="date" className="field rounded px-3 py-2" value={it.date} 
                  onChange={e=>updateItem(i,'date',e.target.value)} />
                <select className="field rounded px-3 py-2" value={it.type} 
                  onChange={e=>updateItem(i,'type',e.target.value)}>
                  <option value="taxi">Taxi</option>
                  <option value="bus">Bus</option>
                  <option value="train">Train</option>
                  <option value="purchase">Purchase</option>
                </select>
                <input type="number" className="field rounded px-3 py-2" placeholder="Amount (NOK)" 
                  value={it.amount} onChange={e=>updateItem(i,'amount',e.target.value)} />
                <input className="field rounded px-3 py-2 md:col-span-3" placeholder="Note (optional)" 
                  value={it.note} onChange={e=>updateItem(i,'note',e.target.value)} />
                <div className="md:col-span-6 flex justify-between items-center">
                  <div className="muted text-sm">{it.type} — {it.amount || 0} NOK</div>
                  <button className="px-3 py-1 rounded-lg border border-gray-600" onClick={()=>removeItem(i)}>
                    <i className="fa-solid fa-trash"></i>
                  </button>
                </div>
              </div>
            ))}
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={addItem}>
              <i className="fa-solid fa-plus mr-2"></i>Add expense
            </button>
          </div>

          <div className="mt-6">
            <h3 className="font-semibold mb-2">Receipts</h3>
            <div ref={dndRef} className="p-4 rounded-xl bg-gray-900 border-2 border-dashed border-gray-700 text-center">
              <p className="muted">Drag & drop images here, or</p>
              <div className="flex flex-wrap gap-2 justify-center mt-2">
                <button className="px-4 py-2 rounded-lg border border-gray-600" 
                  onClick={()=>inputRef.current?.click()}>
                  <i className="fa-solid fa-upload mr-2"></i>Select images
                </button>
                <label className="px-4 py-2 rounded-lg border border-gray-600 cursor-pointer">
                  <input type="file" accept="image/*" capture="environment" className="hidden" 
                    onChange={onPickFiles} />
                  <i className="fa-solid fa-camera mr-2"></i>Use camera
                </label>
              </div>
              <input ref={inputRef} type="file" accept="image/*" multiple className="hidden" 
                onChange={onPickFiles} />
            </div>

            {expenses.receipts.length>0 && (
              <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                {expenses.receipts.map(r => (
                  <div key={r.id} className="p-3 rounded-xl bg-gray-900 border border-gray-700">
                    <div className="relative w-full aspect-w-4 aspect-h-3">
                      <img src={r.dataUrl} alt={r.name} 
                        style={{ transform:`rotate(${r.rotation}deg)` }} 
                        className="w-full h-48 object-contain rounded" />
                    </div>
                    <div className="flex justify-between items-center mt-2">
                      <div className="text-xs muted truncate">{r.name}</div>
                      <div className="flex gap-2">
                        <button className="px-2 py-1 border border-gray-600 rounded" 
                          title="Rotate left" onClick={()=>rotate(r.id,-90)}>
                          <i className="fa-solid fa-rotate-left"></i>
                        </button>
                        <button className="px-2 py-1 border border-gray-600 rounded" 
                          title="Rotate right" onClick={()=>rotate(r.id,90)}>
                          <i className="fa-solid fa-rotate-right"></i>
                        </button>
                        <button className="px-2 py-1 border border-gray-600 rounded" 
                          title="Remove" onClick={()=>removeImg(r.id)}>
                          <i className="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="mt-4 p-3 rounded-lg bg-gray-900 border border-gray-700">
            <div className="muted text-xs">Expenses total</div>
            <div className="text-xl font-semibold">{total.toFixed(2)} NOK</div>
          </div>

          <div className="flex flex-wrap gap-3 mt-6">
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={onPrev}>
              <i className="fa-solid fa-arrow-left mr-2"></i>Previous
            </button>
            <button className="btn px-4 py-2 rounded-lg" onClick={onNext}>
              Next: Review & Sign<i className="fa-solid fa-arrow-right ml-2"></i>
            </button>
          </div>
        </div>
      );
    }

    function ReviewPage({ info, timesheet, trips, expenses, onPrev }) {
      const summaryRef = useRef(null);

      function mailtoHref(){
        const subject = encodeURIComponent(`Submission — ${info.firstName} ${info.lastName}`);
        const body = encodeURIComponent(
          `Employee: ${info.firstName} ${info.lastName} (ID: ${info.employeeId})\n`+
          `Project: ${info.project}\n`+
          `Week: ${info.weekStart} to ${info.weekEnd}\n\n`+
          `Timesheet days: ${timesheet.length}\n`+
          `Travel trips: ${trips.length}\n`+
          `Expense items: ${expenses.items.length}\n\n`+
          `Please find attached the PDF summary.`
        );
        return `mailto:${info.email}?subject=${subject}&body=${body}`;
      }

      async function downloadPDF(){
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit:'pt', format:'a4' });

        // Render summary to canvas via html2canvas
        const node = summaryRef.current;
        const canvas = await html2canvas(node, { scale: 2, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/png');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
        const imgW = canvas.width * ratio;
        const imgH = canvas.height * ratio;
        pdf.addImage(imgData, 'PNG', (pageWidth-imgW)/2, 20, imgW, imgH);

        // Add each receipt as its own page
        for (const r of expenses.receipts) {
          pdf.addPage();
          // rotate if needed by drawing to temp canvas
          let dataUrl = r.dataUrl;
          if (r.rotation % 360 !== 0) {
            const img = await new Promise(res=>{
              const im=new Image(); 
              im.onload=()=>res(im); 
              im.src=r.dataUrl; 
            });
            const c = document.createElement('canvas');
            const ctx = c.getContext('2d');
            const angle = (r.rotation*Math.PI)/180;
            const sin = Math.abs(Math.sin(angle));
            const cos = Math.abs(Math.cos(angle));
            c.width = img.width*cos + img.height*sin;
            c.height = img.width*sin + img.height*cos;
            ctx.translate(c.width/2, c.height/2);
            ctx.rotate(angle);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            dataUrl = c.toDataURL('image/png');
          }
          const imgProps = await new Promise(res=>{
            const im = new Image();
            im.onload = ()=>res({ w: im.width, h: im.height });
            im.src = dataUrl;
          });
          const rRatio = Math.min(pageWidth/imgProps.w, pageHeight/imgProps.h);
          const w = imgProps.w * rRatio;
          const h = imgProps.h * rRatio;
          pdf.addImage(dataUrl, 'PNG', (pageWidth-w)/2, (pageHeight-h)/2, w, h);
        }

        pdf.save(`submission_${info.firstName}_${info.lastName}.pdf`);
      }

      function calcTotals(){
        let totalHours=0, overtime=0, food=0;
        timesheet.forEach(d=>{
          const h = Math.max(0, hoursBetween(d.start,d.end) - (Number(d.lunchMins)||0)/60);
          totalHours += h;
          if (h>8) overtime += (h-8);
          if (d.foodSelfPaid) food += NOK_FOOD_REIMBURSE;
        });
        const totalKm = trips.reduce((s,t)=> s+(parseFloat(t.km)||0), 0);
        const travel = Number((totalKm*KM_RATE).toFixed(2));
        const exp = expenses.items.reduce((s,it)=> s+(parseFloat(it.amount)||0), 0);
        return { 
          totalHours: totalHours.toFixed(2), 
          overtime: overtime.toFixed(2), 
          food, travel, exp, totalKm 
        };
      }
      const totals = calcTotals();

      return (
        <div className="card rounded-2xl p-6">
          <h2 className="text-2xl font-semibold mb-4">Review & Sign</h2>

          <div ref={summaryRef} className="bg-white text-black rounded-xl p-5">
            <h3 className="text-xl font-semibold mb-2">Employee Summary</h3>
            <div className="grid sm:grid-cols-2 gap-2 text-sm">
              <div><strong>Name:</strong> {info.firstName} {info.lastName}</div>
              <div><strong>ID:</strong> {info.employeeId}</div>
              <div><strong>Department:</strong> {info.department}</div>
              <div><strong>Project:</strong> {info.project}</div>
              <div><strong>Email:</strong> {info.email}</div>
              <div><strong>Bankaccount:</strong> {info.bankaccount}</div>
              <div className="sm:col-span-2"><strong>Address:</strong> {info.address}, {info.country}</div>
              <div><strong>Week:</strong> {info.weekStart} to {info.weekEnd}</div>
            </div>

            <div className="mt-3">
              <h4 className="font-semibold">Timesheet</h4>
              <table className="w-full text-xs border mt-1">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="p-1 text-left">Date</th>
                    <th className="p-1">Start</th>
                    <th className="p-1">End</th>
                    <th className="p-1">Lunch</th>
                    <th className="p-1">Food?</th>
                    <th className="p-1 text-left">Note</th>
                    <th className="p-1">Hours</th>
                  </tr>
                </thead>
                <tbody>
                  {timesheet.map((d,i)=>{
                    const h = Math.max(0, hoursBetween(d.start,d.end) - (Number(d.lunchMins)||0)/60);
                    return (
                      <tr key={i}>
                        <td className="p-1">{d.date}</td>
                        <td className="p-1 text-center">{d.start}</td>
                        <td className="p-1 text-center">{d.end}</td>
                        <td className="p-1 text-center">{d.lunchMins}m</td>
                        <td className="p-1 text-center">{d.foodSelfPaid? 'Yes':'No'}</td>
                        <td className="p-1">{d.note}</td>
                        <td className="p-1 text-center">{h.toFixed(2)}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            <div className="mt-3 grid sm:grid-cols-3 gap-2 text-sm">
              <div><strong>Total hours:</strong> {totals.totalHours}</div>
              <div><strong>Overtime:</strong> {totals.overtime}</div>
              <div><strong>Food reimbursement:</strong> {totals.food} NOK</div>
              <div><strong>Total km:</strong> {totals.totalKm}</div>
              <div><strong>Travel reimburse:</strong> {totals.travel} NOK</div>
              <div><strong>Expenses total:</strong> {totals.exp} NOK</div>
            </div>

            <div className="mt-4">
              <h4 className="font-semibold">Receipt thumbnails</h4>
              <div className="grid grid-cols-4 gap-6 mt-2">
                {expenses.receipts.map(r => (
                  <div key={r.id} className="text-center">
                    <img src={r.dataUrl} alt={r.name} 
                      style={{ transform:`rotate(${r.rotation}deg)` }} 
                      className="w-full h-24 object-contain border" />
                    <div className="text-[10px] break-words">{r.name}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <div className="flex flex-wrap gap-3 mt-6">
            <button className="px-4 py-2 rounded-lg border border-gray-600" onClick={onPrev}>
              <i className="fa-solid fa-arrow-left mr-2"></i>Previous
            </button>
            <button className="btn px-4 py-2 rounded-lg" onClick={downloadPDF}>
              <i className="fa-solid fa-file-pdf mr-2"></i>Download PDF
            </button>
            <a className="px-4 py-2 rounded-lg border border-gray-600" href={mailtoHref()}>
              <i className="fa-solid fa-envelope mr-2"></i>Email Summary
            </a>
          </div>
        </div>
      );
    }

    function Toolbar({ data, setData }) {
      function clearAll(){ 
        if (confirm('Clear all local data?')) setData(defaultData()); 
      }
      function save(){ 
        localStorage.setItem('employee_submission_app', JSON.stringify(data)); 
        alert('Progress saved to this device.'); 
      }
      function load(){ 
        const raw = localStorage.getItem('employee_submission_app'); 
        if (raw) { 
          try { 
            setData(JSON.parse(raw)); 
            alert('Progress loaded.'); 
          } catch { 
            alert('Failed to load saved data.'); 
          } 
        } else { 
          alert('No saved data found.'); 
        } 
      }
      function exportJson(){ 
        const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' }); 
        const a=document.createElement('a'); 
        a.href=URL.createObjectURL(blob); 
        a.download='submission_export.json'; 
        a.click(); 
      }
      function importJson(e){ 
        const f=e.target.files[0]; 
        if (!f) return; 
        const reader=new FileReader(); 
        reader.onload=()=>{ 
          try{ 
            const obj=JSON.parse(reader.result); 
            setData(obj); 
            alert('Imported.'); 
          }catch{ 
            alert('Invalid file.'); 
          } 
        }; 
        reader.readAsText(f); 
        e.target.value=''; 
      }

      return (
        <div className="card rounded-2xl p-4 mb-4 flex flex-wrap gap-2 items-center justify-between">
          <div className="font-semibold">Employee Submission System</div>
          <div className="flex flex-wrap gap-2">
            <button className="px-3 py-1.5 rounded-lg border border-gray-600" onClick={save}>
              <i className="fa-solid fa-save mr-2"></i>Save
            </button>
            <button className="px-3 py-1.5 rounded-lg border border-gray-600" onClick={load}>
              <i className="fa-solid fa-rotate mr-2"></i>Load
            </button>
            <button className="px-3 py-1.5 rounded-lg border border-gray-600" onClick={exportJson}>
              <i className="fa-solid fa-file-export mr-2"></i>Export
            </button>
            <label className="px-3 py-1.5 rounded-lg border border-gray-600 cursor-pointer">
              <input type="file" accept="application/json" className="hidden" onChange={importJson} />
              <i className="fa-solid fa-file-import mr-2"></i>Import
            </label>
            <button className="px-3 py-1.5 rounded-lg border border-red-600 text-red-300" onClick={clearAll}>
              <i className="fa-solid fa-trash mr-2"></i>Clear
            </button>
          </div>
        </div>
      );
    }

    function defaultData(){
      return {
        info: { ...initialInfo },
        timesheet: [],
        trips: [],
        expenses: { items: [], receipts: [] },
        step: 0,
      };
    }

    function App(){
      const [data, setData] = useLocalStorage('app_state_v4', defaultData());
      const { info, timesheet, trips, expenses, step } = data;

      function setInfo(v){ setData({ ...data, info: v }); }
      function setTimesheet(v){ setData({ ...data, timesheet: v }); }
      function setTrips(v){ setData({ ...data, trips: v }); }
      function setExpenses(v){ setData({ ...data, expenses: v }); }
      function setStep(v){ setData({ ...data, step: v }); }

      return (
        <div>
          <Toolbar data={data} setData={setData} />
          <TopBar step={step} setStep={setStep} />
          {step===0 && <InfoPage info={info} setInfo={setInfo} onNext={()=>setStep(1)} />}
          {step===1 && <TimesheetPage info={info} timesheet={timesheet} setTimesheet={setTimesheet} 
            onPrev={()=>setStep(0)} onNext={()=>setStep(2)} />}
          {step===2 && <TravelPage trips={trips} setTrips={setTrips} 
            onPrev={()=>setStep(1)} onNext={()=>setStep(3)} />}
          {step===3 && <ExpensesPage expenses={expenses} setExpenses={setExpenses} 
            onPrev={()=>setStep(2)} onNext={()=>setStep(4)} />}
          {step===4 && <ReviewPage info={info} timesheet={timesheet} trips={trips} expenses={expenses} 
            onPrev={()=>setStep(3)} />}
          <div className="text-center mt-6 text-xs muted">
            Optimized for desktop and mobile • Your data stays in your browser unless exported
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('app'));
  </script>
</body>
</html>